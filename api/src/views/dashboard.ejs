<%- include('partials/header') %>



  <!-- Deploy Section -->
  <div class="window" style="max-width: 400px; margin-left: 0;">
    <div class="title-bar">
      <span>Deploy New App</span>
    </div>
    <div class="window-body">
      <div class="deploy-section">
        <form id="deployForm" style="display: flex; gap: 10px; align-items: center;">
          <input type="file" name="file" accept=".zip" required>
          <button type="submit">Deploy App</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Apps List -->
  <div class="window">
    <div class="title-bar">
      <span>Applications</span>
    </div>
    <div class="window-body">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <% apps.forEach(app=> { %>
            <tr class="status-<%= app.status %>">
              <td>
                <%= app.id %>
              </td>

              <td>
                <form method="post" action="/apps/<%= app.id %>/rename" style="display: flex; gap: 5px;">
                  <input type="text" name="name" value="<%= app.name || '' %>">
                  <button>Rename</button>
                </form>
              </td>

              <td>
                <%= app.status %>
              </td>

              <td class="actions">
                <% if (app.status==='running' ) { %>
                  <form method="post" action="/apps/<%= app.id %>/stop" style="display:inline;">
                    <button>Stop</button>
                  </form>
                  <% } %>

                    <% if (app.status==='stopped' ) { %>
                      <form method="post" action="/apps/<%= app.id %>/start" style="display:inline;">
                        <button>Start</button>
                      </form>
                      <% } %>

                        <button onclick="deleteApp(<%= app.id %>)">Delete</button>
              </td>
            </tr>
            <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.getElementById('deployForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const btn = e.target.querySelector('button');

      try {
        btn.disabled = true;
        btn.textContent = 'Uploading...';

        const res = await fetch('/api/deploy', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Upload failed');
        }

        alert('App Queued! ID: ' + data.appId);
        location.reload();

      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Deploy App';
      }
    });

    function deleteApp(id) {
      if (!confirm('Delete app ' + id + '?')) return;
      fetch('/apps/' + id, { method: 'DELETE' })
        .then(() => location.reload());
    }
  </script>

  <%- include('partials/footer') %>