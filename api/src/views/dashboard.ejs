<%- include('partials/header') %>

  <div style="margin-bottom: 15px; padding: 10px; border: 2px groove white;">
    <p style="margin: 0; font-weight: bold;">Welcome to BaysWorld Platform Manager</p>
    <p style="margin: 5px 0 0 0;">A lightweight Platform-as-a-Service (PaaS) for deploying and managing Node.js
      applications. Monitor system status, deploy zip files, and manage your containers with a classic experience.</p>
  </div>




  <!-- System Status -->
  <div class="window" style="max-width: 400px; margin-left: 0;">
    <div class="title-bar">
      <span>System Status</span>
    </div>
    <div class="window-body">
      <table style="border: none;">
        <tr>
          <td style="border: none;">API Server</td>
          <td style="border: none;"><span class="status-running"
              style="padding: 2px 5px; border: 1px solid #000;">ONLINE</span></td>
        </tr>
        <tr>
          <td style="border: none;">Database</td>
          <td style="border: none;">
            <% if (systemStatus.database==='running' ) { %>
              <span class="status-running" style="padding: 2px 5px; border: 1px solid #000;">ONLINE</span>
              <% } else { %>
                <span class="status-failed" style="padding: 2px 5px; border: 1px solid #000;">OFFLINE</span>
                <% } %>
          </td>
        </tr>
        <tr>
          <td style="border: none;">Worker (Build)</td>
          <td style="border: none;">
            <% if (systemStatus.workerBuild==='running' ) { %>
              <span class="status-running" style="padding: 2px 5px; border: 1px solid #000;">ONLINE</span>
              <% } else { %>
                <span class="status-failed" style="padding: 2px 5px; border: 1px solid #000;">OFFLINE</span>
                <% } %>
          </td>
        </tr>
        <tr>
          <td style="border: none;">Worker (Runtime)</td>
          <td style="border: none;">
            <% if (systemStatus.workerRuntime==='running' ) { %>
              <span class="status-running" style="padding: 2px 5px; border: 1px solid #000;">ONLINE</span>
              <% } else { %>
                <span class="status-failed" style="padding: 2px 5px; border: 1px solid #000;">OFFLINE</span>
                <% } %>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Deploy Section -->
  <div class="window" style="max-width: 400px; margin-left: 0;">
    <div class="title-bar">
      <span>Deploy New App</span>
    </div>
    <div class="window-body">
      <div class="deploy-section">
        <form id="deployForm" style="display: flex; gap: 10px; align-items: center;">
          <input type="file" name="file" accept=".zip" required>
          <button type="submit">Deploy App</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Apps List -->
  <div class="window">
    <div class="title-bar">
      <span>Applications</span>
    </div>
    <div class="window-body">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <% apps.forEach(app=> { %>
            <tr class="status-<%= app.status %>">
              <td>
                <%= app.id %>
              </td>

              <td>
                <form method="post" action="/apps/<%= app.id %>/rename" style="display: flex; gap: 5px;">
                  <input type="text" name="name" value="<%= app.name || '' %>">
                  <button>Rename</button>
                </form>
              </td>

              <td>
                <%= app.status %>
              </td>

              <td class="actions">
                <% if (app.status==='running' ) { %>
                  <form method="post" action="/apps/<%= app.id %>/stop" style="display:inline;"
                    onsubmit="handleAction(this, 'Stopping')">
                    <button>Stop</button>
                  </form>
                  <% } %>

                    <% if (app.status==='stopped' ) { %>
                      <form method="post" action="/apps/<%= app.id %>/start" style="display:inline;"
                        onsubmit="handleAction(this, 'Starting')">
                        <button>Start</button>
                      </form>
                      <% } %>

                        <button onclick="deleteApp(<%= app.id %>)">Delete</button>
              </td>
            </tr>
            <% }) %>
        </tbody>
      </table>
    </div>
  </div>


  <div class="status-bar">
    <span>Ready</span>
    <span>User: Guest</span>
    <span>v1.0.0</span>
    <span style="margin-left: auto;">Â© 2026 BaysWorld Inc.</span>
  </div>

  <script>
    document.getElementById('deployForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const btn = e.target.querySelector('button');

      try {
        btn.disabled = true;
        btn.textContent = 'Uploading...';

        const res = await fetch('/api/deploy', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Upload failed');
        }

        alert('App Queued! ID: ' + data.appId);
        location.reload();

      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Deploy App';
      }
    });

    function deleteApp(id) {
      if (!confirm('Delete app ' + id + '?')) return;
      fetch('/apps/' + id, { method: 'DELETE' })
        .then(() => location.reload());
    }

    function handleAction(form, action) {
      const btn = form.querySelector('button');
      btn.textContent = action + '...';
      btn.disabled = true;
      alert(action + ' application... This process may take a few seconds. Please wait.');
      // Allow form submission to continue
      // We re-enable in case it fails or back button is pressed, though reload happens usually.
      setTimeout(() => { btn.disabled = false; btn.textContent = action.replace('ing', ''); }, 10000);
    }
  </script>

  <%- include('partials/footer') %>